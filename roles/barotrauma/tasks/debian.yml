---
- name: Add 32bit architecture installation for Debian
  ansible.builtin.import_tasks: debian-32bit.yml

- name: Add packages for Debian
  ansible.builtin.import_tasks: debian-packages.yml

- name: Install GameDig
  ansible.builtin.import_tasks: debian-gamedig.yml

- name: Create btserver user
  ansible.builtin.user:
    name: btserver
    shell: /bin/bash
    append: yes
    groups:
      - staff

- name: Create Ansible temp directory
  ansible.builtin.shell:
    cmd: mkdir -p /home/btserver/.ansible/tmp
  become: true
  become_user: btserver

- name: Retrieve LinuxGSM script
  ansible.builtin.get_url:
    url: https://linuxgsm.sh
    dest: /home/btserver/linuxgsm.sh
    mode: '755'
  become: true
  become_user: btserver

- name: Install Barotrauma module
  ansible.builtin.shell:
    cmd: ./linuxgsm.sh btserver
    chdir: /home/btserver
  become: true
  become_user: btserver

- name: Install Barotrauma
  ansible.builtin.shell:
    cmd: ./btserver auto-install
    chdir: /home/btserver
  become: true
  become_user: btserver

- name: Apply hotfixes for Debian
  ansible.builtin.import_tasks: debian-hotfixes.yml

- name: Ensure local share directory exists
  ansible.builtin.file:
    path: "/home/btserver/.local/share/Daedalic Entertainment GmbH/Barotrauma"
    state: directory
    mode: 0755
    group: btserver
    owner: btserver

- name: Register if a Multiplayer mount exists
  ansible.builtin.stat:
    path: /data/Multiplayer
  register: multiplayer_mount

- name: Link Multiplayer mount
  ansible.builtin.file:
    src: /data/Multiplayer
    path: "/home/btserver/.local/share/Daedalic Entertainment GmbH/Barotrauma/Multiplayer"
    state: link
  when: multiplayer_mount.stat.exists

- name: Install serverscripts
  ansible.builtin.import_tasks: serverscripts.yml
