---
- name: Ensure build dependencies
  ansible.builtin.apt:
    pkg:
      - build-essential
      - curl
      - ffmpeg
      - git
      - libjpeg-turbo-progs
      - libheif-examples
      - perl
      - python3-dev

- name: Create photostructure user
  ansible.builtin.user:
    name: photostructure
    password: '*'
    shell: /bin/bash

- name: Fetch Node.js installer
  ansible.builtin.uri:
    url: https://deb.nodesource.com/setup_16.x
    return_content: yes
  register: nodejs_installer

- name: Run Node.js installer
  ansible.builtin.shell:
    cmd: bash -
    stdin: "{{ nodejs_installer.content }}"

- name: Install Node.js
  ansible.builtin.apt:
    pkg:
      - nodejs

- name: Install Photostructure
  ansible.builtin.git:
    repo: https://github.com/photostructure/photostructure-for-servers.git
    dest: /home/photostructure/photostructure-for-servers
  become: yes
  become_user: photostructure

- name: Install Photostructure service file
  ansible.builtin.copy:
    src: ./photostructure.service
    dest: /lib/systemd/system/photostructure.service
    owner: photostructure
    group: photostructure
    mode: 0644
  notify:
    - reload systemctl

- name: Start Photostructure
  ansible.builtin.service:
    name: photostructure.service
    state: started
    enabled: yes
